<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Keypad</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <meta name="x-build" content="keypad-single-2025-11-12">
  <style>
    html,body{height:100%}
    body{margin:0;background:#000;color:#fff;font-family:-apple-system,system-ui;display:grid;place-items:center}
    .wrap{width:100%;max-width:420px;padding:24px}
    h1{margin:0 0 16px 0;text-align:center;font-weight:600}
    #code{width:100%;font-size:32px;padding:20px;text-align:center;border-radius:12px;background:#111;color:#fff;border:none;margin-bottom:24px}
    .keys{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
    .keys button{font-size:32px;padding:24px;border:none;border-radius:12px;background:#222;color:#fff}
    #go{background:#ff7a00}
    #del{background:#333}
    #status{margin-top:20px;text-align:center;font-size:18px;color:#bbb;min-height:1.6em}
    .mark{position:fixed;bottom:8px;left:8px;opacity:.35;font:12px/1.2 -apple-system,system-ui}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Enter Your Code</h1>
    <input id="code" maxlength="6" inputmode="numeric" autocomplete="off" aria-label="6-digit code">
    <div id="pad" class="keys"></div>
    <div id="status" aria-live="polite"></div>
  </div>

  <div class="mark">build: keypad-single-2025-11-12</div>

  <script>
  (function(){
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations().then(function(regs){ regs.forEach(function(r){ r.unregister(); }); });
    }

    var CODE_LEN = 6;
    var API_URL = '/api/codes/validate';

    var $ = function(s){ return document.querySelector(s); };
    var pad = $('#pad');
    var codeInput = $('#code');
    var status = $('#status');

    pad.innerHTML = '';
    var keys = ['1','2','3','4','5','6','7','8','9','del','0','go'];
    for (var i=0;i<keys.length;i++){
      var k = keys[i];
      var b = document.createElement('button');
      b.textContent = (k==='del'?'Del':k==='go'?'Go':k);
      if (k==='del') b.id='del';
      if (k==='go')  b.id='go';
      b.setAttribute('data-k', k);
      pad.appendChild(b);
    }

    var busy = false;

    function setStatus(m){ status.textContent = m || ''; }
    function setCode(v){
      var next = String(v||'').replace(/\D+/g,'').slice(0, CODE_LEN);
      codeInput.value = next;
      if (next.length === CODE_LEN) submit();
    }
    function push(d){ if (!busy) setCode((codeInput.value||'') + d); }
    function delOne(){ if (!busy) setCode((codeInput.value||'').slice(0,-1)); }

    pad.addEventListener('click', function(ev){
      var b = ev.target.closest('button'); if(!b) return;
      var k = b.getAttribute('data-k');
      if (/^\d$/.test(k)) return push(k);
      if (k==='del') return delOne();
      if (k==='go') return submit();
    });

    pad.addEventListener('touchstart', function(ev){
      var b = ev.target.closest('button'); if(!b) return;
      ev.preventDefault();
      var k = b.getAttribute('data-k');
      if (/^\d$/.test(k)) return push(k);
      if (k==='del') return delOne();
      if (k==='go') return submit();
    }, {passive:false});

    window.addEventListener('keydown', function(e){
      if (/^\d$/.test(e.key)) return push(e.key);
      if (e.key === 'Backspace') return delOne();
      if (e.key === 'Enter') return submit();
    });

    codeInput.setAttribute('inputmode','numeric');
    codeInput.setAttribute('pattern','\\d*');

    async function submit(){
      if (busy) return;
      var entered = (codeInput.value||'').trim();
      if (!new RegExp('^\\d{' + CODE_LEN + '}$').test(entered)){
        setStatus('Please enter ' + CODE_LEN + ' digits.');
        return;
      }
      busy = true; setStatus('Checking code…');

      try{
        var ctl = new AbortController();
        var t = setTimeout(function(){ ctl.abort(); }, 10000);
        var res = await fetch(API_URL, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ code: entered, consume: true }),
          signal: ctl.signal
        });
        clearTimeout(t);
        var data = {};
        try{ data = await res.json(); }catch(e){ data = {}; }

        if (!res.ok || !data.ok){
          setStatus((data && data.message) ? data.message : 'Invalid or expired code.');
          busy = false; return;
        }

        setStatus('Code accepted — launching…');

        var dest = '/capture.html'
          + '?code=' + encodeURIComponent(data.code || '')
          + '&tier=' + encodeURIComponent(data.tier || '')
          + (data.event ? '&event=' + encodeURIComponent(data.event) : '');
        window.location.href = dest;
        return;
      }catch(e){
        setStatus('Network error. Check API.');
        busy = false;
      }
    }
  })();
  </script>
</body>
</html>
