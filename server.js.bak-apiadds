require('dotenv').config();
const path = require('path');
const express = require('express');
const mongoose = require('mongoose');

const app = express();

/* ---------------- Core middleware ---------------- */
app.use(express.json({ limit: '20mb' }));
app.use(express.urlencoded({ extended: false }));

/* ---------------- Static /public ------------------ */
app.use(express.static(path.join(__dirname, 'public')));

/* ---------------- MongoDB connect ----------------- */
(async () => {
  const uri = process.env.MONGO_URI || '';
  if (!uri) {
    console.warn('âš ï¸  MONGO_URI not set. Codes/tiers that need DB may use in-memory fallback (if implemented).');
    return;
  }
  try {
    await mongoose.connect(uri);
    console.log('âœ… MongoDB connected');
  } catch (err) {
    console.error('âŒ Mongo connect error:', err && err.message ? err.message : err);
  }
})();

/* ---------------- Routes -------------------------- */
const codesRouter  = require('./routes/codes');
const tiersRouter  = require('./routes/tiers');
const configRoute  = require('./routes/config');

app.use('/api/codes',  codesRouter);
console.log('âœ… Mounted /api/codes from ./routes/codes');

app.use('/api/tiers',  tiersRouter);
console.log('âœ… Mounted /api/tiers from ./routes/tiers');

app.use('/api/config', configRoute);
console.log('âœ… Mounted /api/config from ./routes/config');

/* ---------------- Health checks ------------------- */
app.get('/api/health', (_req, res) => res.json({ ok: true }));
// Keep compatibility if you were curling this before:
app.get('/api/codes/health', (_req, res) => res.json({ ok: true }));

/* ------------- HTML direct serving --------------- */
/* Serve specific html files directly if requested */
app.get(/\/[^/]+\.html$/, (req, res) => {
  return res.sendFile(path.join(__dirname, 'public', req.path));
});

/* ---------------- Start server -------------------- */
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`âœ… Server running on port ${PORT}`);
});

/* -------------- Graceful shutdown ----------------- */
process.on('SIGINT', () => { console.log('ðŸ›‘ SIGINT'); process.exit(0); });
process.on('SIGTERM', () => { console.log('ðŸ›‘ SIGTERM'); process.exit(0); });
