require('dotenv').config();
const path = require('path');
const express = require('express');
const mongoose = require('mongoose');

const app = express();

app.use(express.json({ limit: '20mb' }));
app.use(express.urlencoded({ extended: false }));

app.use(express.static(path.join(__dirname, 'public')));
app.use('/uploads', express.static(path.join(__dirname, 'uploads')));

(async () => {
  const uri = process.env.MONGO_URI || '';
  if (!uri) {
    console.warn('MONGO_URI not set.');
    return;
  }
  try {
    await mongoose.connect(uri);
    console.log('âœ… MongoDB connected');
  } catch (err) {
    console.error('âŒ Mongo connect error:', err && err.message ? err.message : err);
  }
})();

const codesRouter  = require('./routes/codes');
const tiersRouter  = require('./routes/tiers');
const configRoute  = require('./routes/config');
const aiRoute      = require('./routes/ai');
const uploadsRoute = require('./routes/uploads');

app.use('/api/codes',  codesRouter);
console.log('âœ… Mounted /api/codes from ./routes/codes');

app.use('/api/tiers',  tiersRouter);
console.log('âœ… Mounted /api/tiers from ./routes/tiers');

app.use('/api/config', configRoute);
console.log('âœ… Mounted /api/config from ./routes/config');

app.use('/api/ai', aiRoute);
console.log('âœ… Mounted /api/ai from ./routes/ai');

app.use('/api/uploads', uploadsRoute);
console.log('âœ… Mounted /api/uploads from ./routes/uploads');

app.get('/api/health', (_req, res) => res.json({ ok: true }));
app.get('/api/codes/health', (_req, res) => res.json({ ok: true }));

app.get(/\/[^/]+\.html$/, (req, res) => {
  return res.sendFile(path.join(__dirname, 'public', req.path));
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`âœ… Server running on port ${PORT}`);
});

process.on('SIGINT', () => { console.log('ðŸ›‘ SIGINT'); process.exit(0); });
process.on('SIGTERM', () => { console.log('ðŸ›‘ SIGTERM'); process.exit(0); });
