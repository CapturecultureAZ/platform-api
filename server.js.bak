// -------------------------------------------------------------
// Capture Culture platform-api — clean server.js
// -------------------------------------------------------------

require('dotenv').config();
const express = require('express');
const cors = require('cors');
const helmet = require('helmet');
const path = require('path');
const mongoose = require('mongoose');

// Create app
const app = express();

// Middleware
app.use(cors());
app.use(helmet());
app.use(express.json({ limit: '10mb' }));
app.use(express.urlencoded({ extended: false, limit: '10mb' }));

// Serve /public (static assets: keypad.html, capture.html, backdrops, etc.)
app.use(express.static(path.join(__dirname, 'public')));

// MONGO CONNECT
(async () => {
  const uri = process.env.MONGO_URI;
  if (!uri) console.error('⚠️  Missing MONGO_URI in .env');

  try {
    await mongoose.connect(uri, { dbName: 'capture' });
    console.log('✅ MongoDB connected');
  } catch (err) {
    console.error('❌ Mongo connect error:', err.message);
  }
})();

// ROUTES
app.use('/api/codes',    require('./routes/codes'));
app.use('/api/tiers',    require('./routes/tiers'));
app.use('/api/config',   require('./routes/config'));
app.use('/api/ai',       require('./routes/ai'));
app.use('/api/uploads',  require('./routes/uploads'));
app.use('/api/events',   require('./routes/events'));
app.use('/api/compose',  require('./routes/compose')); // ✅ NEW AI background compositor

// Fallback: 404 JSON for unknown API routes
// Fallback: 404 JSON for unknown API routes (catch-all under /api)
app.use('/api', (req, res) => {
  if (!res.headersSent) {
    res.status(404).json({ ok:false, error: 'Unknown API route' });
  }
});

// Everything else → static frontend
app.get('*', (req, res) => {
  res.sendFile(path.join(__dirname, 'public', 'index.html'), err => {
    if (err) res.status(404).send('Not Found');
  });
});

// START SERVER
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`✅ Server running on port ${PORT}`);
});
